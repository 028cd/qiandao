// Generated by CoffeeScript 1.7.1
(function() {
  var __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  define(function(require, exports, module) {
    var analyze_cookies, mime_type, remove_header, sort, utils, xhr;
    utils = require('/static/utils');
    xhr = function(har) {
      var entry, h, _i, _len, _ref;
      _ref = har.log.entries;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entry = _ref[_i];
        if (((function() {
          var _j, _len1, _ref1, _results;
          _ref1 = entry.request.headers;
          _results = [];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            h = _ref1[_j];
            if (h.name === 'X-Requested-With' && h.value === 'XMLHttpRequest') {
              _results.push(h);
            }
          }
          return _results;
        })()).length > 0) {
          entry.filter_xhr = true;
        }
      }
      return har;
    };
    mime_type = function(har) {
      var entry, mt, _i, _len, _ref, _ref1;
      _ref = har.log.entries;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entry = _ref[_i];
        mt = (_ref1 = entry.response.content) != null ? _ref1.mimeType : void 0;
        entry.filter_mimeType = (function() {
          switch (false) {
            case mt.indexOf('audio') !== 0:
              return 'media';
            case mt.indexOf('image') !== 0:
              return 'image';
            case mt.indexOf('javascript') === -1:
              return 'javascript';
            case mt !== 'text/html':
              return 'document';
            case mt !== 'text/css' && mt !== 'application/x-pointplus':
              return 'style';
            case mt.indexOf('application') !== 0:
              return 'media';
            default:
              return 'other';
          }
        })();
      }
      return har;
    };
    analyze_cookies = function(har) {
      var cookie, cookie_jar, cookies, entry, h, header, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3;
      cookie_jar = new utils.CookieJar();
      _ref = har.log.entries;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entry = _ref[_i];
        cookies = {};
        _ref1 = cookie_jar.getCookiesSync(entry.request.url);
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          cookie = _ref1[_j];
          cookies[cookie.key] = cookie.value;
        }
        _ref2 = entry.request.cookies;
        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
          cookie = _ref2[_k];
          if (cookie.name in cookies) {
            if (cookie.value === cookies[cookie.name]) {
              cookie.from_session = true;
              entry.filter_from_session = true;
            } else {
              cookie.cookie_changed = true;
              entry.filter_cookie_changed = true;
              cookie_jar.setCookieSync(utils.Cookie.fromJSON(angular.toJson({
                key: cookie.name,
                value: cookie.value,
                path: '/'
              })), entry.request.url);
            }
          } else {
            cookie.cookie_added = true;
            entry.filter_cookie_added = true;
            cookie_jar.setCookieSync(utils.Cookie.fromJSON(angular.toJson({
              key: cookie.name,
              value: cookie.value,
              path: '/'
            })), entry.request.url);
          }
        }
        _ref3 = (function() {
          var _len3, _m, _ref3, _results;
          _ref3 = entry.response.headers;
          _results = [];
          for (_m = 0, _len3 = _ref3.length; _m < _len3; _m++) {
            h = _ref3[_m];
            if (h.name.toLowerCase() === 'set-cookie') {
              _results.push(h);
            }
          }
          return _results;
        })();
        for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
          header = _ref3[_l];
          entry.filter_set_cookie = true;
          cookie_jar.setCookieSync(header.value, entry.request.url);
        }
      }
      return har;
    };
    sort = function(har) {
      har.log.entries = har.log.entries.sort(function(a, b) {
        if (a.pageref > b.pageref) {
          return 1;
        } else if (a.pageref < b.pageref) {
          return -1;
        } else if (a.startedDateTime > b.startedDateTime) {
          return 1;
        } else if (a.startedDateTime < b.startedDateTime) {
          return -1;
        } else {
          return 0;
        }
      });
      return har;
    };
    remove_header = function(har) {
      var entry, h, to_remove_headers, _i, _len, _ref;
      to_remove_headers = ['X-DevTools-Emulate-Network-Conditions-Client-Id'];
      _ref = har.log.entries;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        entry = _ref[_i];
        entry.request.headers = (function() {
          var _j, _len1, _ref1, _ref2, _results;
          _ref1 = entry.request.headers;
          _results = [];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            h = _ref1[_j];
            if (_ref2 = h.name, __indexOf.call(to_remove_headers, _ref2) < 0) {
              _results.push(h);
            }
          }
          return _results;
        })();
      }
      return har;
    };
    exports.analyze = function(har) {
      return mime_type(analyze_cookies(sort(remove_header(har))));
    };
    return exports;
  });

}).call(this);
