{% extends "base.html" %}

{% block head %}
<link href="{{ static_url('components/bootstrap/dist/css/bootstrap.min.css') }}" rel="stylesheet" type="text/css">
<link href="{{ static_url('har/editor.css') }}" rel="stylesheet" type="text/css">
<script>
  seajs.use('/static/har/editor', function(main) {
    main.init()

    if (location.href.indexOf("?dev") > 0) {
      $.get('/static/www.smzdm.com.har', function(data) {
        data = angular.fromJson(data);
        angular.element('#upload-har').scope().loaded(data);
      })
    }
  });
</script>
{% endblock %}

{% block body %}
{% raw %}
<div class="container">
  <div class="row" ng-controller="EditorCtrl">
    <div class="col-md-3" id="editor-switch">
      <!--checked switch-->
      <div class="list-group">
        <a ng-class="{active: !filter.checked}" class="list-group-item" href="#" ng-click='filter.checked = undefined'>
          <span class="badge">{{ har.log.entries.length }}</span>
          所有请求
        </a>
        <a ng-class="{active: filter.checked}" class="list-group-item" href="#" ng-click='filter.checked = true'>
          <span class="badge">{{ (har.log.entries|filter:{checked:true}).length }}</span>
          已选择请求
        </a>
        <a href="#" class="list-group-item text-right">
          推荐关联请求 &gt;
        </a>
      </div>

      <div class="list-group">
        <a href="#" class="list-group-item"
          ng-repeat="(name, key) in {
            All: undefined,
            Documents: 'document',
            Styles: 'style',
            Images: 'image',
            Media: 'media',
            Others: 'other'
          }"
          ng-class="{active: filter.filter_mimeType == key}"
          ng-click="filter.filter_mimeType = key">
          <span class="badge">{{ (har.log.entries | filter: {checked: filter.checked, filter_mimeType: key}).length }}</span>
          {{ name }}
        </a>
      </div>

      <div class="list-group">
        <a href="#" class="list-group-item"
          ng-class="{active: filter.filter_xhr}"
          ng-click="filter.filter_xhr = filter.filter_xhr ? undefined : true">
          <span class="badge">{{ (har.log.entries | filter: {checked: filter.checked, filter_mimeType: filter.filter_mimeType, filter_xhr: true}).length }}</span>
          XMLHttpRequest
        </a>
        <a href="#" class="list-group-item"
          ng-class="{active: filter.filter_set_cookie}"
          ng-click="filter.filter_set_cookie = filter.filter_set_cookie ? undefined : true">
          <span class="badge">{{ (har.log.entries | filter: {checked: filter.checked, filter_mimeType: filter.filter_mimeType, filter_set_cookie: true}).length }}</span>
          Set-Cookie
        </a>
        <a href="#" class="list-group-item"
          ng-class="{active: filter.filter_cookie_added}"
          ng-click="filter.filter_cookie_added = filter.filter_cookie_added ? undefined : true">
          <span class="badge">{{ (har.log.entries | filter: {checked: filter.checked, filter_mimeType: filter.filter_mimeType, filter_cookie_added: true}).length }}</span>
          JS 新增 Cookie
        </a>
        <a href="#" class="list-group-item"
          ng-class="{active: filter.filter_cookie_changed}"
          ng-click="filter.filter_cookie_changed = filter.filter_cookie_changed ? undefined : true">
          <span class="badge">{{ (har.log.entries | filter: {checked: filter.checked, filter_mimeType: filter.filter_mimeType, filter_cookie_changed: true}).length }}</span>
          JS 修改 Cookie
        </a>
      </div>
    </div>

    <!--entries-->
    <div class="col-md-9" id="entries">
      <div class="list-group">
        <li class="list-group-item pageref"
          ng-repeat-start="entry in har.log.entries | filter: filter | filter: track_item()"
          ng-if="filted[$index-1].pageref != entry.pageref">
          {{ entry.pageref }}
        </li>

        <a href="#" class="list-group-item entry" ng-repeat-end>
          <div class="entry-checked">
            <input ng-model="entry.checked" type="checkbox">
          </div>
          <span class="label pull-right {{ status_label(entry.response.status) }}">{{ entry.response.status }}</span>
          <span class="label pull-right label-info" ng-show="entry.filter_set_cookie">set-cookie</span>
          <span class="label pull-right label-warning" ng-show="entry.filter_xhr">XHR</span>
          <span class="label label-default pull-right" ng-repeat="tag in entry.check_tag">{{ tag }}</span>
          <span class="label" ng-class="{
            'label-warning': (entry.request.method != 'GET'),
            'label-primary': (entry.request.method == 'GET')
            }">{{ entry.request.method }}</span>
          <span class="entry-url" ng-click="edit(entry)">{{ entry.request.url }}</span>
        </a>

        <li class="list-group-item" ng-if="filted.length == 0">过滤条件下没有请求</li>
      </div>
    </div>

    <!--edit entry modal-->
    <div class="modal fade" id="edit-entry" ng-controller="EntryCtrl">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <ul class="nav nav-pills">
              <li ng-class="{active: panel=='request'}">
                <a href="javascript:void(0)" ng-click="panel='request'">Request</a>
              </li>
              <li ng-class="{active: panel=='response'}">
                <a href="javascript:void(0)" ng-click="panel='response'">Response</a>
              </li>
            </ul>
          </div>

          <!-- request -->
          <div class="modal-body" ng-show="panel=='request'">
            <!-- url and method -->
            <dl class="dl-horizontal">
              <dt>Request URL</dt>
              <dd contenteditable data-ph="request url" ng-model="entry.request.url"></dd>
              <dt>Request Method</dt>
              <dd contenteditable data-ph="request method" ng-model="entry.request.method"></dd>
            </dl>
            <!-- headers -->
            <details open>
              <summary>
                Request Headers
                <a class="btn btn-info btn-xs"
                  ng-click="entry.request.headers.unshift({name:'', value:''})">Add</a>
              </summary>
              <dl class="dl-horizontal">
                <dt contenteditable data-ph="header.name"
                ng-repeat-start="header in entry.request.headers | filter:{name: '!Cookie'}"
                ng-model="header.name"></dt>
                <span class="remove" ng-click="delete(header.$$hashKey, entry.request.headers)">&times;</span>
                <dd contenteditable data-ph="header.value" ng-repeat-end ng-model="header.value"></dd>
              </dl>
            </details>
            <!-- cookies -->
            <details open>
              <summary>
                Cookies
                <a class="btn btn-info btn-xs" ng-if="false"
                  ng-click="entry.request.cookies.unshift({name:'', value:'', checked:true})">Add</a>
              </summary>
              <dl class="dl-horizontal">
                <dt ng-repeat-start="cookie in entry.request.cookies" ng-if="!cookie.checked">{{ cookie.name }}</dt>
                <dd ng-if="!cookie.checked">
                  {{ cookie.value }}
                  <span class="label label-danger" ng-show="cookie.cookie_added">added</span>
                  <span class="label label-warning" ng-show="cookie.cookie_changed">changed</span>
                  <span class="label label-info" ng-show="cookie.from_session">session</span>
                </dd>
                <dt contenteditable data-ph="cookie.name" ng-model="cookie.name" ng-if="cookie.checked"></dt>
                <span class="remove" ng-if="cookie.checked" ng-click="delete(cookie.$$hashKey, entry.request.cookies)">&times;</span>
                <dd ng-if="cookie.checked" ng-repeat-end>
                  <span contenteditable data-ph="cookie.value" ng-model="cookie.value"></span>
                  <span class="label label-success">added cookie</span>
                </dd>
              </dl>
            </details>
            <!--post data-->
            <div class="modal-body" contenteditable
              ng-model="entry.request.postData.text"
              ng-show="entry.request.postData"> </div>
          </div>

          <!-- response -->
          <div class="modal-body" ng-show="panel=='response'">
            <dl class="dl-horizontal">
              <dt>Status Code</dt>
              <dd><span class="label {{ status_label(entry.response.status) }}">{{ entry.response.status }}</span></dd>
            </dl>
            <details open>
              <summary>Response Headers</summary>
              <dl class="dl-horizontal">
                <dt ng-repeat-start="header in entry.response.headers">{{ header.name }}</dt>
                <dd ng-repeat-end>{{ header.value }}</dd>
              </dl>
            </details>
            <details open>
              <summary>Cookies</summary>
              <dl class="dl-horizontal">
                <dt ng-repeat-start="cookie in entry.response.cookies">{{ cookie.name }}</dt>
                <dd ng-repeat-end>{{ cookie.value }}</dd>
              </dl>
            </details>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-loading-text="Saving..." data-dismiss="modal">Save</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
  </div>


  <div class="modal fade" id="upload-har" ng-controller="UploadCtrl">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">上传HAR</h4>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger" role="alert" style="display: none;">
            <strong>Oh snap!</strong> Change a few things up and try submitting again.
          </div>
          <input type="file">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-loading-text="Loading..." ng-click="upload()">上传</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
</div>
{% endraw %}
{% endblock %}
